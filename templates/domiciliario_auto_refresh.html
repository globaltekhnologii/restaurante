<!-- Auto-Refresh Integration for Delivery Panel -->
<!-- Add this before </head> -->
<link rel="stylesheet" href="css/auto_refresh.css">

<!-- Add this after navbar -->
<div id="refresh-indicator" class="refresh-indicator"></div>
<div class="auto-refresh-controls">
    <button id="btn-toggle-refresh" class="btn-auto-refresh active" onclick="toggleAutoRefresh()">
        <span id="refresh-icon">‚ñ∂Ô∏è</span>
        <span id="refresh-text">Auto-actualizaci√≥n activa</span>
    </button>
    <button id="btn-toggle-sound" class="btn-sound-toggle" onclick="toggleSound()" title="Activar/Desactivar sonido">
        üîî
    </button>
</div>

<!-- Add this before </body> -->
<script src="js/auto_refresh.js"></script>
<script>
    let pedidosRefresh;
    let lastPedidosCount = 0;

    // Funci√≥n para renderizar pedidos del domiciliario
    function renderPedidosDomicilio(data) {
        if (!data.pedidos || data.pedidos.length === 0) {
            return `<div class="empty-state">
                <div class="emoji">üèçÔ∏è</div>
                <h3>No hay pedidos para entregar</h3>
                <p>Todos los pedidos han sido entregados</p>
            </div>`;
        }

        let html = '';
        data.pedidos.forEach(pedido => {
            const estadoClass = pedido.estado;
            const badgeClass = `badge-${estadoClass}`;
            const esMio = pedido.es_mio;

            html += `<div class="pedido-card ${estadoClass} ${esMio ? 'mi-pedido' : ''}">
                <div class="pedido-header">
                    <div>
                        <div class="pedido-numero">${pedido.numero_pedido}</div>
                        <div class="pedido-cliente">üë§ ${pedido.nombre_cliente}</div>
                    </div>
                    <span class="badge ${badgeClass}">${capitalize(pedido.estado)}</span>
                </div>
                
                <div class="pedido-info">
                    <div>üìû ${pedido.telefono}</div>
                    <div>üìç ${pedido.direccion}</div>
                    <div>üíµ Total: $${formatNumber(pedido.total)}</div>
                    <div>‚è∞ ${pedido.hora}</div>
                </div>`;

            html += `<div class="pedido-actions">`;

            if (pedido.estado === 'listo' && !esMio) {
                html += `<a href="tomar_pedido.php?pedido_id=${pedido.id}" class="btn btn-primary">
                    üèçÔ∏è Tomar Pedido
                </a>`;
            } else if (pedido.estado === 'en_camino' && esMio) {
                html += `<a href="cambiar_estado.php?pedido_id=${pedido.id}&nuevo_estado=entregado" class="btn btn-success">
                    ‚úÖ Marcar como Entregado
                </a>`;
            }

            html += `<a href="ver_pedido.php?id=${pedido.id}" class="btn btn-secondary">
                üëÅÔ∏è Ver Detalles
            </a></div></div>`;
        });

        return html;
    }

    function capitalize(str) {
        return str.charAt(0).toUpperCase() + str.slice(1);
    }

    function formatNumber(num) {
        return Math.round(num).toLocaleString('es-CO');
    }

    // Inicializar auto-refresh
    document.addEventListener('DOMContentLoaded', function () {
        pedidosRefresh = new AutoRefresh({
            endpoint: 'api/get_pedidos_domiciliario.php',
            targetElement: '.pedidos-grid',
            interval: 8000, // 8 segundos
            renderFunction: renderPedidosDomicilio,
            onNewItems: function (newItems) {
                ToastNotification.show(
                    `üèçÔ∏è ${newItems.length} nuevo(s) pedido(s) para entregar`,
                    'new',
                    5000
                );
                NotificationSound.play('new_order');
            },
            onUpdate: function (data) {
                if (data.total !== lastPedidosCount) {
                    lastPedidosCount = data.total;
                }
            }
        });

        pedidosRefresh.start();
        console.log('‚úÖ Auto-refresh iniciado para panel de domiciliario');
    });

    // Funciones de control
    function toggleAutoRefresh() {
        if (pedidosRefresh.isPaused) {
            pedidosRefresh.resume();
            document.getElementById('btn-toggle-refresh').classList.add('active');
            document.getElementById('btn-toggle-refresh').classList.remove('paused');
            document.getElementById('refresh-icon').textContent = '‚ñ∂Ô∏è';
            document.getElementById('refresh-text').textContent = 'Auto-actualizaci√≥n activa';
        } else {
            pedidosRefresh.pause();
            document.getElementById('btn-toggle-refresh').classList.remove('active');
            document.getElementById('btn-toggle-refresh').classList.add('paused');
            document.getElementById('refresh-icon').textContent = '‚è∏Ô∏è';
            document.getElementById('refresh-text').textContent = 'Auto-actualizaci√≥n pausada';
        }
    }

    function toggleSound() {
        const enabled = NotificationSound.toggle();
        const btn = document.getElementById('btn-toggle-sound');
        if (enabled) {
            btn.classList.remove('muted');
            btn.textContent = 'üîî';
            ToastNotification.show('Sonido activado', 'success', 2000);
        } else {
            btn.classList.add('muted');
            btn.textContent = 'üîï';
            ToastNotification.show('Sonido desactivado', 'info', 2000);
        }
    }

    // Inicializar estado del bot√≥n de sonido
    if (!NotificationSound.isEnabled()) {
        document.getElementById('btn-toggle-sound').classList.add('muted');
        document.getElementById('btn-toggle-sound').textContent = 'üîï';
    }
</script>